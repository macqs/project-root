<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>학생용 퀴즈</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; }
    canvas { border: 1px solid #000; margin: 20px 0; touch-action: none; }
    button { padding: 10px 20px; font-size: 16px; margin: 5px; }
  </style>
</head>
<body>
  <h2>퀴즈 문제</h2>
  <div id="question">퀴즈를 불러오는 중입니다...</div>

  <canvas id="canvas" width="300" height="150"></canvas><br>
  <button onclick="clearCanvas()">다시 쓰기</button>
  <button onclick="submitCanvas()">제출</button>

  <div id="result" style="margin-top:20px; font-weight:bold;"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    // ===============================
    // Firebase 연동 (퀴즈 문제 수신)
    // ===============================
    const firebaseConfig = {
      apiKey: "AIzaSyD7r3ynx6_GoRQHUxnEyTW1smnRflge6W0",
      authDomain: "qr-quiz-74448.firebaseapp.com",
      databaseURL: "https://qr-quiz-74448-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "qr-quiz-74448",
      storageBucket: "qr-quiz-74448.appspot.com",
      messagingSenderId: "1061064370375",
      appId: "1:1061064370375:web:05f3a5fdacdf78d05b36e2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const questionMap = {
      high: "겨울에 하늘에서 내리는 것은?",
      medium: "ㄴ + ㅜ + ㄴ 하면 어떤 낱말이 되나요?",
      low: "이미지 문제: 눈.JPG"
    };

    const questionDiv = document.getElementById("question");
    db.ref("quiz/currentDifficulty").on("value", (snapshot) => {
      const level = snapshot.val();
      questionDiv.innerText = questionMap[level] || "문제를 불러오는 중입니다...";
    });

    // ===============================
    // 캔버스 필기 기능
    // ===============================
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (e.clientX || e.touches[0].clientX) - rect.left,
        y: (e.clientY || e.touches[0].clientY) - rect.top
      };
    }

    canvas.addEventListener('mousedown', e => {
      drawing = true;
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    });
    canvas.addEventListener('mousemove', e => {
      if (!drawing) return;
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseleave', () => drawing = false);

    canvas.addEventListener('touchstart', e => {
      drawing = true;
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    });
    canvas.addEventListener('touchmove', e => {
      if (!drawing) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    canvas.addEventListener('touchend', () => drawing = false);

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById("result").innerText = "";
    }

    // ===============================
    // Google Vision API로 글씨 인식
    // ===============================
    function submitCanvas() {
      const resultDiv = document.getElementById("result");
      resultDiv.innerText = "인식 중...";

      const base64Image = canvas.toDataURL().split(',')[1];

      fetch("https://vision.googleapis.com/v1/images:annotate?key=AIzaSyCRAXWGAi-858lQxa3hN15EBHdwZdthu2M", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          requests: [
            {
              image: { content: base64Image },
              features: [{ type: "DOCUMENT_TEXT_DETECTION" }]
            }
          ]
        })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.responses || !data.responses[0]) {
          resultDiv.innerText = "인식 실패: Vision API 응답 없음";
          console.error("응답 없음", data);
          return;
        }

        const text = data.responses[0].fullTextAnnotation?.text || "";
        const clean = text.replace(/\s/g, '');
        console.log("인식 결과:", clean);

        if (clean.includes("눈")) {
          resultDiv.innerText = `정답! (${clean})`;
        } else {
          resultDiv.innerText = `오답입니다. (${clean})`;
        }
      })
      .catch(err => {
        resultDiv.innerText = "인식 실패: " + err.message;
        console.error(err);
      });
    }
  </script>
</body>
</html>
